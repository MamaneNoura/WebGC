<!DOCTYPE html PUBLIC>
<html lang="en">
<head>
   <link href="webgc_demo.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="../../bower_components/peerjs/peer.js"></script>
  <script type="text/javascript" src="../../src/utils/LoggerForWebWorker.js"></script>
  <script type="text/javascript" src="../../src/utils/GossipUtil.js"></script>
  <script type="text/javascript" src="../../src/patterns/GossipFactory.js"></script>
  <script type="text/javascript" src="../../src/apis/GossipProtocol.js"></script>
  <script type="text/javascript" src="../../src/algorithms/Vicinity.js"></script>
  <script type="text/javascript" src="../../src/algorithms/Cyclon.js"></script>
  <script type="text/javascript" src="../../src/controllers/Coordinator.js"></script>
  <script type="text/javascript" src="../../src/utils/Plotter.js"></script>
  <script type="text/javascript" src="../../src/conf_objs/twoSimFunc.js"></script>
  <script>
   
    function getGraph(host, port, plotterLoop, workers){
      var http = new XMLHttpRequest();
      var url = 'http://' + host + ':' + port + '/getGraph';
      var self = this;
      http.open('get', url, true);
      http.onerror = function(e) {
        self.log.error('Trying to get graph for loop ' + plotterLoop);
      };
      http.onreadystatechange = function() {
        if (http.readyState !== 4) { return; }
        if (http.status !== 200) {
          http.onerror();
          return;
        }
        console.log('Graph ' + http.responseText + ' for loop ' + plotterLoop);
        var nodes = JSON.parse(http.responseText);
        var msg = {header: 'view', graph: nodes};
        var keys = Object.keys(workers), worker;
        for(var i = 0; i < keys.length; i++){
          worker = workers[ keys[i] ];
          worker.postMessage(msg);
        }
      };
      http.send(null);
    }
    
    function addLogToTable(trace){
      var keys = Object.keys(trace), field;
      var row = document.createElement("tr");
      for(var i = 0; i < keys.length; i++){
        field = document.createElement("th");
        field.appendChild(document.createTextNode(trace[ keys[i] ]));
        row.appendChild(field);
      }
      document.getElementById(trace.algoId).appendChild(row);
    }
    
    function addStatsToTable(trace){
      var keys = Object.keys(trace), field;
      var row = document.createElement("tr");
      for(var i = 0; i < keys.length; i++){
        field = document.createElement("th");
        field.appendChild(document.createTextNode(trace[ keys[i] ]));
        row.appendChild(field);
      }
      document.getElementById(trace.algoId + '-stats').appendChild(row);
    }
    
    function appendLogSection(algoId){
      var c1 = document.createElement('th');
      c1.appendChild(document.createTextNode('Algo ID'));
      var c2 = document.createElement('th');
      c2.appendChild(document.createTextNode('Gossip Cycle'));
      var c3 = document.createElement('th');
      c3.appendChild(document.createTextNode('Active Cycle Offset (s)'));
      
      var trEl = document.createElement('tr');
      trEl.appendChild(c1);
      trEl.appendChild(c2);
      trEl.appendChild(c3);
      
      var tableEl = document.createElement('table');
      var idAtt = document.createAttribute('id');
      idAtt.value = algoId;
      tableEl.setAttributeNode(idAtt);
      tableEl.appendChild(trEl);
      
      var divEl = document.createElement('div');
      divEl.appendChild(tableEl);
      document.getElementById('logSec').appendChild(document.createTextNode('Active Cycle Statistics'));
      document.getElementById('logSec').appendChild(divEl);
    }
    
    function appendStatsSection(algoId){
      var c1 = document.createElement('th');
      c1.appendChild(document.createTextNode('ProtocolId'));
      var c2 = document.createElement('th');
      c2.appendChild(document.createTextNode('Gossip Cycle'));
      var c3 = document.createElement('th');
      c3.appendChild(document.createTextNode('View'));
      var c4 = document.createElement('th');
      c4.appendChild(document.createTextNode('ViewUpd Offset (ms)'));
      
      var trEl = document.createElement('tr');
      trEl.appendChild(c1);
      trEl.appendChild(c2);
      trEl.appendChild(c3);
      trEl.appendChild(c4);
      
      var tableEl = document.createElement('table');
      var idAtt = document.createAttribute('id');
      idAtt.value = algoId + '-stats';
      tableEl.setAttributeNode(idAtt);
      tableEl.appendChild(trEl);
      
      var divEl = document.createElement('div');
      divEl.appendChild(tableEl);
      document.getElementById('logSec').appendChild(document.createTextNode('View Updates Statistics'));
      document.getElementById('logSec').appendChild(divEl);
    }
    
    function start(){
      var peerId = document.getElementById('user').value;
      if(peerId === '')
        alert("Type a peer ID");
      else{
        document.getElementById('start').disabled = true;
        var listObj = document.getElementById('list');
        var profile = {vicinity1: [], vicinity2: []}, i, j, limit, elem;
        var listsLen = {1: 7, 2: 9};
        for(i = 1; i <= 2; i++ ){
          limit = listsLen[i];
          for(j = 1; j <= limit; j++){
            elem = document.getElementById('p' + i + '_' + j);
            profile['vicinity' + i].push(elem.checked === true ? elem.value : 'undefined');
          }
        }
        var atts = Object.keys(configurationObj.gossipAlgos);
        for(i = 0; i < atts.length; i++){
          appendLogSection(atts[i]);
          appendStatsSection(atts[i]);
        }
        var controller = new Coordinator(configurationObj, profile, peerId);
        controller.setLogFunction(addLogToTable);
        controller.listen();
        if(!configurationObj.logOpts.activated){
          window.setInterval(function(){
            var histo = controller.getViewUpdHistory();
            var keys = Object.keys(histo), traces, ks, i, j;
            for(i = 0; i < keys.length; i++){
              traces = histo[ keys[i] ];
              ks = Object.keys(traces);
              for(j = 0; j < ks.length; j++){ addStatsToTable(traces[ ks[j] ]); }
            }
            histo = controller.getActiCycHistory();
            keys = Object.keys(histo);
            for(i = 0; i < keys.length; i++){
              traces = histo[ keys[i] ];
              ks = Object.keys(traces);
              for(j = 0; j < ks.length; j++){ addLogToTable(traces[ ks[j] ]); }
            }
            controller.emptyHistoryOfLogs();
          }, configurationObj.logOpts.feedbackPeriod);
        }
        var plotter = new Plotter(controller.log, peerId);
        controller.plotterObj = plotter;
        window.setInterval( function(){
          plotter.ref = controller.id;
          var host = configurationObj.peerJsOpts.host;
          var port = configurationObj.peerJsOpts.port;
          getGraph(host, port, plotter.loop, controller.workers);
          plotter.loop++;
        }, configurationObj.logOpts.feedbackPeriod);
      }
    }
    
    //Not Used
    document.addEventListener('DOMContentLoaded', function(event){ });
    
  </script>
</head>
<body>
  <div id="main" class="mainContainer">
    <div id="form" class="formContainer">
      <h2>User ID and preferences</h2>
      User ID: <input type="text" id="user" placeholder="Write your ID, here!">
      <br>
      First profile: 
      <p>
        <input type="checkbox" id="p1_1" value="Internet of Things"/>Internet of Things
        <input type="checkbox" id="p1_2" value="P2P Systems"  />P2P Systems
        <input type="checkbox" id="p1_3" value="Cloud Computing"/>Cloud Computing
        <input type="checkbox" id="p1_4" value="Big Data"/>Big Data
        <input type="checkbox" id="p1_5" value="Gossiping"/>Gossiping
        <input type="checkbox" id="p1_6" value="Optimization"/>Optimization
        <input type="checkbox" id="p1_7" value="Recommendation Systems"/>Recommendation Systems
      </p><br>
      Second profile:
      <p>
        <input type="checkbox" id="p2_1" value="Metaheuristics"/>Metaheuristics
        <input type="checkbox" id="p2_2" value="Fuzzy Systems"/>Fuzzy Systems
        <input type="checkbox" id="p2_3" value="Emerging Applications"/>Emerging Applications
        <input type="checkbox" id="p2_4" value="Computational Neuroscience"/>Computational Neuroscience
        <input type="checkbox" id="p2_5" value="Algorithms"/>Algorithms
        <input type="checkbox" id="p2_6" value="Emerging Technology"/>Emerging Technology
        <input type="checkbox" id="p2_7" value="Multi-Agent Systems"/>Multi-Agent Systems
        <input type="checkbox" id="p2_8" value="Cellular Automata"/>Cellular Automata
        <input type="checkbox" id="p2_9" value="Scalable Numerical Algorithms"/>Scalable Numerical Algorithms
      </p><br>
      <input class="button" type="button" value="START" id="start" onclick="start()">
    </div>
    <div id="graphs" class="graphsContainer">
      <div id="cyclon1" class="rpsContainer"></div>
      <div id="vicinity1" class="cluContainer"></div>
      <div id="vicinity2" class="rpsContainer"></div>
    </div>
    <div id="peerInfo"></div>
    <br><br><br>
    <div id="logSec"></div>
  </div>
</body>
</html>
