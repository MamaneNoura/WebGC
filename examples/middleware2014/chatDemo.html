<!DOCTYPE html PUBLIC>
<html lang="en">
<head>
  <title>WebGC demo</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
  <meta http-equiv="Content-Language" content="en-us">
  <link href="webgc_demo.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="../../bower_components/jquery/dist/jquery.min.js"></script> 
  <script type="text/javascript" src="../../bower_components/peerjs/peer.js"></script>
  <script type="text/javascript" src="../../bower_components/cytoscape/dist/cytoscape.js"></script>
  <script type="text/javascript" src="../../src/utils/LoggerForWebWorker.js"></script>
  <script type="text/javascript" src="../../src/utils/GossipUtil.js"></script>
  <script type="text/javascript" src="../../src/services/LookupService.js"></script>
  <script type="text/javascript" src="../../src/services/GossipFactory.js"></script>
  <script type="text/javascript" src="../../src/superObjs/GossipProtocol.js"></script>
  <script type="text/javascript" src="../../src/algorithms/Vicinity.js"></script>
  <script type="text/javascript" src="../../src/algorithms/Cyclon.js"></script>
  <script type="text/javascript" src="../../src/services/Bootstrap.js"></script>
  <script type="text/javascript" src="../../src/services/Plotter.js"></script>
  <script type="text/javascript" src="../../src/controllers/Coordinator.js"></script>
  <script type="text/javascript" src="./twoSimFunc.js"></script>
  
  <script>
    var mainObjs = {};
    
    function writeDownInChat(msg){
      if(document.getElementById(msg.emitter)){
        $('#' + msg.emitter + '_msgs').append(
          $('<div><span class="peer">' + msg.emitter + ': </span>' + msg.payload + '</div>')
        );
      }else
        addChatElement(msg.emitter, msg.payload, false);
    }
    
    function sendInChat(){
      var activeCons = $('.active');
      activeCons.each(function(){
        var peerId = $(this).attr('id');
        var txt = document.getElementById('text').value;
        var cons = mainObjs['controller'].connections[peerId];
        for(var i = 0; i < cons.length; i++){
          if(cons[i].label === 'chat'){
            cons[i].send({msg: txt});
            $('#' + peerId).append('<div><span class="you">You: </span>' + txt + '</div>');
            break;
          }
        }
      });
      $('#text').val('');
      $('#text').focus();
    }
    
    function performConnectionsForChat(peerIds){
      if(mainObjs['currentChatCons'])
        closeChatCons();
      mainObjs['currentChatCons'] = peerIds;
      for(var i = 0; i < peerIds.length; i++)
        createChatConnection(peerIds[i]);
    }
    
    function closeChatCons(){
      var cons = mainObjs['controller'].connections, consPerP, peerId;
      for(var i = 0, ii = mainObjs['currentChatCons'].length; i < ii; i++){
        peerId = mainObjs['currentChatCons'][i];
        $('#' + peerId).remove();
        consPerP = cons[peerId];
        for(var j = 0, jj = consPerP.length; j < jj; j++){
          if(consPerP[j].label === 'chat'){
            consPerP[j].close();
            consPerP[j] = {};
            break;
          }
        }
      }
      $('.filler').show();
    }
    
    function setObjsChatCo(c){
      var chatbox = $('<div></div>').addClass('connection').attr('id', c.peer);
      var header = $('<h1></h1>').html('Chat with <strong>' + c.peer + '</strong>');
      var messages = $('<div><em>Peer connected.</em></div>').addClass('messages');
      chatbox.append(header);
      chatbox.append(messages);
      chatbox.on('click', function() {
        if ($(this).attr('class').indexOf('active') === -1)
          $(this).addClass('active');
        else
          $(this).removeClass('active');
      });
      $('.filler').hide();
      $('#connections').append(chatbox);
      
      c.on('data', function(data){
        console.info('MsgFromChatCon');
        console.info(data);
        $('#' + c.peer).append('<div><span class="peer">' + c.peer + '</span>: ' + data.msg + '</div>'); 
      });
      
      c.on('error', function(e){
        console.log('In chat connection with: ' + c.peer);
      });
    }
    
    function createChatConnection(receiver){
      var contr = mainObjs['controller'];
      var con = contr.connect(receiver, {
        label: 'chat',
        serialization: 'json'
      });
      
      con.on('open', function(){
        setObjsChatCo(con);
      });
      
      con.on('error', function(e){
        console.error('In chat connection. Error: ' + e);
      });
    }
    
    function getGraph(host, port, plotterLoop, workers, algoName){
      var http = new XMLHttpRequest();
      var url = 'http://' + host + ':' + port + '/getGraph';
      var self = this;
      http.open('get', url, true);
      http.onerror = function(e) {
        self.log.error('Trying to get graph for loop ' + plotterLoop);
      };
      http.onreadystatechange = function() {
        if (http.readyState !== 4) { return; }
        if (http.status !== 200) {
          http.onerror();
          return;
        }
        console.log('Graph ' + http.responseText + ' for loop ' + plotterLoop);
        var nodes = JSON.parse(http.responseText);
        var msg = {header: 'view', graph: nodes};
        var keys = Object.keys(workers), worker;
        for(var i = 0; i < keys.length; i++){
          if(keys[i].match(algoName + '[0-9]')){
            worker = workers[ keys[i] ];
            worker.postMessage(msg);
          }
        }
      };
      http.send(null);
    }
    
    function postKeepAlive(host, port, peerId){
      var url = 'http://' + host + ':' + port + '/keepAlive';
      var xhr = new XMLHttpRequest();
      var self = this;
      xhr.open('POST', url, true);
      xhr.setRequestHeader('Content-type', 'text/plain');
      xhr.onreadystatechange = function(){
        if (xhr.readyState !== 4){ return; }
        if (xhr.status !== 200) { xhr.onerror(); return; }
        var res = JSON.parse(xhr.responseText);
        if(res.success)
          console.info('Keep alive was posted');
        else
          console.error('Keep alive was not received by the server');
      };
      xhr.onerror = function(){
        console.error('While posting keep alive msg');
      };
      var msg = {id: peerId};
      xhr.send(JSON.stringify(msg));
    }
    
    function isPeeridValid(host, port, peerId){
      var url = 'http://' + host + ':' + port + '/checkPeerId';
      var xhr = new XMLHttpRequest();
      var self = this;
      xhr.open('POST', url, true);
      xhr.setRequestHeader('Content-type', 'text/plain');
      xhr.onreadystatechange = function(){
        if (xhr.readyState !== 4){ return; }
        if (xhr.status !== 200) { xhr.onerror(); return; }
        console.info('isPeerValid ? ' + xhr.responseText);
        var res = JSON.parse(xhr.responseText);
        if(!res.answer)
          self.launchPeer(peerId, host, port);
        else{
          alert('The peerId you typed was already taken, please give another one');
          $('#user').val('');
          $('#user').focus();
        }
      };
      xhr.onerror = function(){
        console.error('While checking if peerId is valid');
      };
      var msg = {id: peerId};
      xhr.send(JSON.stringify(msg));
    }
    
    function launchPeer(peerId, host, port){
      document.getElementById('start').disabled = true;
      var profile = [];
      for(var i = 1; i <=3 ; i++)
        profile.push(document.getElementById("list" + i).value);
      var controller = new Coordinator(configurationObj,{vicinity1: profile}, peerId);
      controller.setApplicationLevelFunction(setObjsChatCo);
      mainObjs['controller'] = controller;
      controller.listen();
      var plotter = new Plotter(peerId, {}, performConnectionsForChat);
      controller.plotterObj = plotter;
      var itC = 1;
      var self = this;
      var itPool = window.setInterval(function(){
        if(itC % 2 === 0)
          $('#waitMsg').hide();
        else
          $('#waitMsg').show();
        itC++;
      }, 1000);
      window.setInterval(function(){
        self.postKeepAlive(host, port, controller.id);
      }, 3000);
      window.setInterval( function(){
        $('#waitMsg').hide();
        clearInterval(itPool);
        getGraph(host, port, plotter.loop, controller.workers, 'cyclon');
      }, 12000);
      window.setInterval( function(){
        plotter.loop++;
        getGraph(host, port, plotter.loop, controller.workers, 'vicinity');
      }, 27000);
    }
    
    function start(){
      var peerId = document.getElementById('user').value;
      var host = configurationObj.peerJsOpts.host;
      var port = configurationObj.peerJsOpts.port;
      if(peerId && peerId !== '')
        isPeeridValid(host, port, peerId);
      else
        alert("Your PeerID could not be empty");
    }
    
    document.addEventListener('DOMContentLoaded', function(event){
      console.log('Page was loaded');
      $('#user').focus();
      $('#waitMsg').hide();
    });
    
  </script>
</head>
<body style="zoom: 1; background-color: #ddd;">
  <div id="main" class="mainContainer">
    <div id="form" class="formContainer">
      <h2>Preferences</h2>
        Your PeerId: <input type="text" id="user" placeholder="Write your ID, here!">
        <button class="button" type="button" id="start" onclick="start()">START</button>
        <h1 id="waitMsg"><strong>Application has initiated, performing connections with other peers!</strong></h1>
        <br><br>
        Your profile is:
        <select id="list1">
          <option value="v1">Internet of Things</option>
          <option value="v2">P2P Systems</option>
          <option value="v3">Cloud Computing</option>
          <option value="v4">Big Data</option>
          <option value="v5">Gossiping</option>
          <option value="v6">Optimization</option>
          <option value="v7">Recommendation Systems</option>
        </select>
        <select id="list2">
          <option value="v1">Internet of Things</option>
          <option value="v2">P2P Systems</option>
          <option value="v3">Cloud Computing</option>
          <option value="v4">Recommendation protocols</option>
          <option value="v5">Gossiping</option>
          <option value="v6">Optimization</option>
          <option value="v7">Recommendation Systems</option>
        </select>
        <select id="list3">
          <option value="v1">Internet of Things</option>
          <option value="v2">P2P Systems</option>
          <option value="v3">Cloud Computing</option>
          <option value="v4">Recommendation protocols</option>
          <option value="v5">Gossiping</option>
          <option value="v6">Optimization</option>
          <option value="v7">Recommendation Systems</option>
        </select>
    </div>
    <div id="graphs" class="graphsContainer">
      <div id="cyclon1" class="rpsContainer">
        <h1><strong>RPS Overlay </strong></h1>
      </div>
      <div id="vicinity1" class="cluContainer">
        <h1><strong>Clustering Overlay</strong></h1>
      </div>
    </div>
    <div id="chat" class="chatContainer">
      <div id="actions">
        <form id="send">
          <input type="text" id="text" placeholder="Enter message">
          <button class="button" type="button" onclick='sendInChat()'>Send to selected peers</button>
        </form>
      </div>
      <div id="wrap"><div id="connections"><span class="filler">You have not yet
        made any connections.</span></div>
        <div class="clear"></div>
      </div>
    </div>
  </div>
</body>  
</html>
