/*! peerjs-gossip 2014-06-16 */
!function(a){function b(a){if("number"!=typeof a||0>a)throw"The preference is not valid";this.proxVal=a}b.prototype._eval=function(a,b){return"number"!=typeof a||"number"!=typeof b?(console.log("ProximityFunc: eval() with non numbers"),null):Math.abs(a-b)},b.prototype._getClosestSubdic=function(a,b){var c=Object.keys(b);if(0>=a||0===c.length)return{};if(c.length<=a)return b;var d,e,f=[];for(d in b)e="data"in b[d]?this._eval(this.proxVal,b[d].data):null,f.push({k:d,v:e});f.sort(function(a,b){return a.v-b.v});for(var g={},h=[],i=0,j=f.length;j>i;i+=1)if(d=f[i].k,e=f[i].v,null===e)h.push(i);else{if(!(Object.keys(g).length<a))break;g[d]=b[d]}for(var k;Object.keys(g).length<a;)k=h.pop(),d=f[k].k,g[d]=b[d];return g},a.DumbProximityFunc=b}(this),function(a){function b(a){a&&(this.url="http://"+a.host+":"+a.port+"/log"),this.localConsole=!1,this.layoutPattern="[%-5p] %d{yyyy.MM.dd HH:mm:ss} [%-10f{1}] [%-10f{2}] :: %m","undefined"==typeof log4javascript?this.logger=log4javascript.getLogger():this.localConsole=!0}function c(a){this.log=new b(a.loggingServer)}b.prototype.info=function(a){this.localConsole?console.log(a):this.logger.info(a)},b.prototype.warn=function(a){this.localConsole?console.log(a):this.logger.warn(a)},b.prototype.error=function(a){this.localConsole?console.log(a):this.logger.error(a)},b.prototype.fatal=function(a){this.localConsole?console.log(a):this.logger.fatal(a)},b.prototype.setOutput=function(a,b){var c,d;c=this.url?new log4javascript.AjaxAppender(this.url):new log4javascript.BrowserConsoleAppender,d=new log4javascript.PatternLayout(this.layoutPattern),d.setCustomField("id",a),d.setCustomField("class",b),c.setLayout(d),this.logger.removeAllAppenders(),this.logger.addAppender(c)},b.prototype.getLogStr=function(a){return Array.prototype.slice.call(a).join(" ")},a.Logger=b,c.prototype.newItem=function(a,b){return{age:a,data:b}},c.prototype.getRandomSubDict=function(a,b){if(0>=a||0===Object.keys(b).length)return{};if(a>=Object.keys(b).length)return b;var c,d,e,f={},g={};for(c in b)f[c]=1;e=0;do d=Object.keys(f),c=d[Math.floor(Math.random()*d.length)],g[c]=b[c],delete f[c],e+=1;while(e!=a);return g},c.prototype.getOldestKey=function(a){var b=Object.keys(a);if(0===b.length)return this.log.error("Empty dictionary"),null;for(var c=a[b[0]].age,d=b[0],e=1;e<b.length;)a[b[e]].age>c&&(c=a[b[e]].age,d=b[e]),e+=1;return d},c.prototype.getRandomKey=function(a){var b=null,c=Object.keys(a),d=c.length;if(0===d)this.log.error("No way to return a key from an empty dictionary");else{var e;e=1===d?0:Math.floor(Math.random()*d),b=c[e]}return b},c.prototype.removeRandomly=function(a,b){if(0!==a){var c,d,e={};for(d in b)e[d]=1;for(var f=0;a>f;f+=1)c=Object.keys(e),d=c[Math.floor(Math.random()*c.length)],delete e[d],delete b[d]}},c.prototype.mergeViews=function(a,b){var c,d=Object.keys(a),e=Object.keys(b),f={};for(c=0;c<d.length;c++)f[d[c]]=a[d[c]];for(c=0;c<e.length;c++)"undefined"!=typeof f[e[c]]?b[e[c]].age<f[e[c]].age&&(f[e[c]]=b[e[c]]):f[e[c]]=b[e[c]];return f},c.prototype.setData=function(a,b,c){b in a&&(a[b].data=c)},c.prototype.extendProperties=function(a,b){for(var c=Object.keys(b),d=0;d<c.length;d++)a.hasOwnProperty(c[d])||(a[c[d]]=b[c[d]])},a.GossipUtil=c}(this),function(a){function b(a){this.class=a.class,this.view={},this.loop=0,this.data=a.data,this.viewSize=a.viewSize,this.fanout=a.fanout,this.periodTime=a.periodTime,this.propagationPolicy=a.propagationPolicy,this.nonImpMsg="An implementation for this method is required"}b.prototype.increaseAge=function(){throw this.nonImpMsg},b.prototype.getLog=function(){throw this.nonImpMsg},b.prototype.selectPeer=function(){throw this.nonImpMsg},b.prototype.getItemsToSend=function(){throw this.nonImpMsg},b.prototype.selectItemsToKeep=function(){throw this.nonImpMsg},b.prototype.initialize=function(){throw this.nonImpMsg},a.GossipProtocol=b}(this),function(a){function b(a){this.peerId=a.peerId,this.loggingServer=a.loggingServer,this.inventory={},this.log=new Logger(a.loggingServer),this.log.setOutput(a.peerId,this.constructor.name),this.gossipUtil=new GossipUtil({loggingServer:a.loggingServer}),this.gossipUtil.log.setOutput(a.peerId,this.constructor.name)}b.prototype.checkProperties=function(a){if("undefined"==typeof a.data)throw"The local data could be defined";if("number"!=typeof a.viewSize||a.viewSize<1)throw"Protocol's size view is not valid";if("number"!=typeof a.fanout||a.fanout<1)throw"Protocol's message size is not valid";if("number"!=typeof a.periodTimeOut||a.periodTimeOut<2e3)throw"Protocol's periodicity is not valid";if("boolean"!=typeof a.propagationPolicy.push)throw"Propagation policy (push) is not boolean";if("boolean"!=typeof a.propagationPolicy.pull)throw"Propagation policy (pull) is not boolean"},b.prototype.createProtocol=function(b,c){try{var d;if(this.log.info("PASO: "+this.constructor.name),"string"!=typeof b.class)throw"The class of the algorithm must be a string";this.log.info("Type: "+b.class);var e=a[b.class];if("undefined"==typeof e)throw"Object does not exist in the library of the system";if(this.gossipUtil.extendProperties(b,e.defaultOpts),this.gossipUtil.extendProperties(b,{peerId:this.peerId,loggingServer:this.loggingServer}),this.checkProperties(b),this.log.info(JSON.stringify(b)),d=new e(b),this.log.info(typeof d),this.inventory.hasOwnProperty(c))throw"The Object's identifier ("+c+") already exists";this.inventory[c]=d}catch(f){this.log.error("Gossip-based protocol wasn't created. "+f),this.log.erro("Detail: "+f.message)}},b.prototype.setDependencies=function(){for(var a,b,c,d=Object.keys(this.inventory),e=0;e<d.length;e++)if(a=this.inventory[d[e]],"undefined"!=typeof a.attributes){c=Object.keys(a.attributes);for(var f=0;f<c.length;f++)"undefined"!=typeof a[c[f]]?(b=this.inventory[a.attributes[c[f]]],"undefined"!=typeof b?a[c[f]]=b:this.log("The attribute ["+a.attributes[c[f]]+"] has became undefined")):this.log.error("The attribute ["+c[f]+"] was assigned before extending the object ["+a.class+"]")}},a.GossipFactory=b}(this),function(a){function b(a){this.log=new Logger(a.loggingServer),this.log.setOutput(a.peerId,this.constructor.name),this.gossipUtil=new GossipUtil({loggingServer:a.loggingServer}),this.gossipUtil.setOutput(a.peerId,this.constructor.name),GossipProtocol.call(this,a)}b.defaultOpts={"class":"Cyclon",data:"?",viewSize:10,fanout:5,periodTimeOut:1e4,propagationPolicy:{push:!0,pull:!0}},util.inherits(b,GossipProtocol),b.prototype.selectPeer=function(){return this.gossipUtil.getOldestKey(this.view)},b.prototype.getItemsToSend=function(a,b,c){var d={};switch(c){case"active":delete this.view[b],d=this.gossipUtil.getRandomSubDict(this.fanout-1,this.view),d[a]=this.gossipUtil.newItem(0,this.data);break;case"passive":d=this.gossipUtil.getRandomSubDict(this.fanout,this.view);break;default:this.log.error("Unknown selection policy")}return d},b.prototype.selectItemsToKeep=function(a,b){var c=Object.keys(b);if(0!==c.length){var d,e=Object.keys(this.view);if(0===e.length){d=0;do this.view[c[d]]=b[c[d]],d+=1;while(d<c.length&&Object.keys(this.view).length<this.viewSize)}else{var f={};a in b&&(delete b[a],c=Object.keys(b));for(d=0;d<c.length;d+=1)c[d]in this.view||(f[c[d]]=b[c[d]]);for(d=0;Object.keys(f).length<=this.viewSize&&d<e.length;)f[e[d]]=this.view[e[d]],d+=1;this.view=f}}},b.prototype.initialize=function(a){if(a.length>0)for(var b in a)this.view[a[b]]=this.gossipUtil.newItem(0,"?")},b.prototype.increaseAge=function(){for(var a in this.view)this.view[a].age+=1},b.prototype.setData=function(a,b){this.view[a].data=b},b.prototype.getLog=function(){var a,b="[",c=Object.keys(this.view);if(0===c.length)b+="]";else{a=c.length-1;for(var d=0;a>d;d+=1)b+="("+c[d]+", "+this.view[c[d]].age+"), ";b+="("+c[a]+", "+this.view[c[a]].age+")]"}return b},a.Cyclon=b}(this),function(a){function b(a){return this.log=new Logger(a.loggingServer),this.log.setOutput(a.peerId,this.constructor.name),this.gossipUtil=new GossipUtil({loggingServer:a.loggingServer}),this.gossipUtil.setOutput(a.peerId,this.constructor.name),GossipProtocol.call(this,a),this.selectionPolicy=a.selectionPolicy,this.proximityFunc=this.instantiateSimFunc(a.similarityFunction),"undefined"===this.proximityFunc?(this.log.error("A similarity functions is not specified forVicinity. The instance of Vicinity will be null."),null):void 0}b.defaultOpts={viewSize:10,fanout:5,periodTimeOut:1e4,propagationPolicy:{push:!0,pull:!0},selectionPolicy:"biased",similarityFunction:"?"},util.inherits(b,GossipProtocol),b.prototype.instantiateSimFunc=function(b){var c;try{if("string"!=typeof b)throw"The name of the function must be a string";var d=a[b];if("undefined"==typeof d)throw"Similarity function does not exist in the library of the system";c=new d(this.data)}catch(e){this.log.error("Similarity function was not instantiaed. "+e)}return c},b.prototype.selectPeer=function(){return this.gossipUtil.getOldestKey(this.view)},b.prototype.getItemsToSend=function(a,b,c){var d,e={};switch(c){case"active":delete this.view[b],d=this.fanout-1;break;case"passive":d=this.fanout;break;default:d=0}switch(this.selectionPolicy){case"random":e=this.gossipUtil.getRandomSubDict(d,this.view);break;case"biased":e=this.proximityFunc._getClosestSubdic(d,this.view);break;case"agr-biased":var f=this.gossipUtil.mergeViews(this.view,this.rpsView);e=this.proximityFunc._getClosestSubdic(d,f);break;default:this.log.error("Unknown peer selection policy")}return"active"===c&&(e[a]=this.gossipUtil.newItem(0,this.proximityFunc.proxVal)),e},b.prototype.selectItemsToKeep=function(a,b){var c=this.gossipUtil.mergeViews(this.view,b),d=this.gossipUtil.mergeViews(c,this.rpsView);a in d&&delete d[a],this.view=this.proximityFunc._getClosestSubdic(this.viewSize,d)},b.prototype.initialize=function(a){if(a.length>0)for(var b in a)this.view[a[b]]=this.gossipUtil.newItem(0,"?")},b.prototype.increaseAge=function(){for(var a=Object.keys(this.view),b=0;b<a.length;b++)this.view[a[b]].age+=1},b.prototype.getSimilarPeerIds=function(a){if(0>=a)return[];var b=Object.keys(this.view);if(a>=b.length)return b;for(var c=[],d=0;a>d;d+=1)c.push(b[d]);return c},b.prototype.getLog=function(){var a,b,c,d="[",e=Object.keys(this.view);if(0===e.length)d+="]";else{a=e.length-1;for(var f=0;a>f;f+=1)c=this.view[e[f]].data,b=this.proximityFunc._eval(this.proximityFunc.proxVal,c),d+="("+e[f]+", "+b+", "+this.view[e[f]].age+"), ";c=this.view[e[a]].data,b=this.proximityFunc._eval(this.proximityFunc.proxVal,c),d+="("+e[a]+", "+b+", "+this.view[e[a]].age+")]"}return this.proximityFunc.proxVal+"_"+d},a.Vicinity=b}(this),function(a){function b(a){this.log=new Logger(a.loggingServer),this.log.setOutput(a.peerId,this.constructor.name),this.gossipUtil=new GossipUtil({loggingServer:a.loggingServer}),this.gossipUtil.setOutput(a.peerId,this.constructor.name),GossipProtocol.call(this,a),this.selectionPolicy=a.selectionPolicy,this.H=a.H,this.S=a.S,this.inVandNonReturned={}}b.defaultOpts={data:"?",viewSize:10,fanout:5,periodTimeOut:1e4,propagationPolicy:{push:!0,pull:!0},selectionPolicy:"random",H:"?",S:"?"},util.inherits(b,GossipProtocol),b.prototype.initialize=function(a){if(0!==a.length)for(var b=0;b<a.length;b+=1)this.view[a[b]]=this.gossipUtil.newItem(0,"?"),this.inVandNonReturned[a[b]]=1},b.prototype.selectPeer=function(){var a,b=Object.keys(this.inVandNonReturned);if(0===b.length)this.log.warn("The quality of returned samples is no longer reliable"),a=this.gossipUtil.getRandomKey(this.view);else{switch(this.selectionPolicy){case"random":a=b[0];break;case"oldest":a=this.gossipUtil.getOldestKey(this.view);break;default:this.log.error("The selection policy is not recognized"),a=b[0]}delete this.inVandNonReturned[a]}return a},b.prototype.permuteView=function(){var a=Object.keys(this.view);if(0!==a.length&&1!==a.length){var b,c,d={},e={},f=[];for(b=0;b<a.length;b++)d[a[b]]=1;for(b=0;b<a.length;b++)f=Object.keys(d),c=f[Math.floor(Math.random()*f.length)],e[c]=this.view[c],delete d[c],delete this.view[c];var g=Object.keys(e);for(b=0;b<g.length;b++)this.view[g[b]]=e[g[b]]}},b.prototype.moveOldest=function(){if(Object.keys(this.view).length>this.H&&this.H>0){var a,b,c=[];for(b=0;b<this.H;b++)a=this.gossipUtil.getOldestKey(this.view),c[b]={key:a,value:this.view[a]},delete this.view[a];for(c.sort(function(a,b){return a.value.age-b.value.age}),b=0;b<c.length;b++)this.view[c[b].key]=c[b].value}},b.prototype.selectItemsToKeep=function(a,b){var c,d=Object.keys(b);for(c=0;c<d.length;c++)d[c]in this.view?b[d[c]].age<this.view[d[c]].age&&(this.view[d[c]]=b[d[c]]):this.view[d[c]]=b[d[c]];var e,f;for(f=Math.min(this.H,Object.keys(this.view).length-this.viewSize),c=0;f>c;c++)e=this.gossipUtil.getOldestKey(this.view),delete this.view[e];for(f=Math.min(this.S,Object.keys(this.view).length-this.viewSize),d=Object.keys(this.view),c=0;f>c;c++)delete this.view[d[c]];for(d=Object.keys(this.view),d.length>this.viewSize&&this.gossipUtil.removeRandomly(d.length-this.viewSize,this.view),d=Object.keys(this.inVandNonReturned),c=0;c<d.length;c++)d[c]in this.view||delete this.inVandNonReturned[key[c]];for(d=Object.keys(this.view),c=0;c<d.length;c++)d[c]in this.inVandNonReturned||(this.inVandNonReturned[d[c]]=1)},b.prototype.getItemsToSend=function(a){var b={};b[a]=this.gossipUtil.newItem(0,this.data),this.permuteView(),this.moveOldest();var c=Math.floor(this.viewSize/2)-1,d=Object.keys(this.view);if(d.length>=c)for(var e=0;c>e;e++)b[d[e]]=this.view[d[e]];return b},b.prototype.increaseAge=function(){for(var a=Object.keys(this.view),b=0;b<a.length;b++)this.view[a[b]].age+=1},b.prototype.getLog=function(){var a,b="[",c=Object.keys(this.view);if(0===c.length)b+="]";else{a=c.length-1;for(var d=0;a>d;d+=1)b+="("+c[d]+", "+this.view[c[d]].age+"), ";b+="("+c[a]+", "+this.view[c[a]].age+")]"}return b},a.SamplingService=b}(this),function(a){function b(a){if(!(this instanceof b))return new b(a);this.log=new Logger(a.loggingServer),this.log.setOutput(a.peerId,this.constructor.name),this.log.info("Class: "+this.constructor.name),this.factory=new GossipFactory({loggingServer:a.loggingServer,peerId:a.peerId});for(var c,d=Object.keys(a.gossipAlgos),e=0;e<d.length;e++)c=a.gossipAlgos[d[e]],this.factory.createProtocol(c,d[e]);var f=this;this.factory.setDependencies(),this.protocols=this.factory.inventory,this.gossipUtil=new GossipUtil({loggingServer:a.loggingServer}),this.gossipUtil.log.setOutput(a.peerId,this.constructor.name),Peer.call(this,a.peerId,a.peerJsOpts),this.on("open",function(){window.setTimeout(function(){f.getFirstView()},1e4)}),this.on("connection",function(a){f.handleConnection(a)}),this.on("doActiveThread",function(a){var b,c,d=Object.keys(f.protocols);for(b=0;b<d.length;b++)c=f.protocols[d[b]],c.initialize(a);window.setInterval(function(){for(var a=Object.keys(f.protocols),b=0;b<a.length;b++)f.doActiveThread(f.protocols[a[b]])},1e4)})}util.inherits(b,Peer),b.prototype.handleConnection=function(a){var b=this.protocols[a.label],c=this;a.on("data",function(a){b.selectItemsToKeep(c.id,a)}),a.on("open",function(){if(b.propagationPolicy.pull){var d=b.getItemsToSend(c.id,a.peer,"passive");a.send(d)}}),a.on("error",function(a){c.log.error("During the reception of a "+b.name+" message"),c.log.error(a)})},b.prototype.doActiveThread=function(a){var b=a.class+"_"+a.loop+"_"+this.id+"_"+a.getLog();this.log.info("{"+b+"}"),a.loop++;var c=a.selectPeer();a.increaseAge();var d=this.connect(c,{label:a.class}),e=this;d.on("open",function(){var b={};a.propagationPolicy.push&&(b=a.getItemsToSend(e.id,d.peer,"active")),d.send(b)}),d.on("data",function(b){a.propagationPolicy.pull&&a.selectItemsToKeep(e.id,b)}),d.on("error",function(b){e.log.error("During the emition of a "+a.object+" message"),e.log.error(b)})},b.prototype.getPeers=function(){for(var a,b,c={},d=this.protocols.Object.keys(),e=0;e<d.length;e++)a=this.protocols[e].class,b=this.protocols[e].view,c[a]=b;return c},b.prototype.getFirstView=function(){var a=new XMLHttpRequest,b=this.options.secure?"https://":"http://",c=b+this.options.host+":"+this.options.port+"/"+this.options.key+"/"+this.id+"/view";a.open("get",c,!0);var d=this;a.onerror=function(){d.log.error("Error retrieving the view of IDs"),d._abort("server-error","Could not get the random view")},a.onreadystatechange=function(){if(4===a.readyState){if(200!==a.status)return void a.onerror();var b=JSON.parse(a.responseText);d.emit("doActiveThread",b)}},a.send(null)},a.Coordinator=b}(this);