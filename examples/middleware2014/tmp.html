<html lang="en">
<head>
  <title>WebGC demo</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
  <meta http-equiv="Content-Language" content="en-us">
  <link href="webgc_demo.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="../../bower_components/jquery/dist/jquery.min.js"></script> 
  <script type="text/javascript" src="../../bower_components/peerjs/peer.js"></script>
  <script type="text/javascript" src="../../bower_components/cytoscape/dist/cytoscape.js"></script>
  <script type="text/javascript" src="../../bower_components/log4javascript/log4javascript.js"></script>
  <script type="text/javascript" src="../../src/utils/LoggerForWebWorker.js"></script>
  <script type="text/javascript" src="../../src/utils/GossipUtil.js"></script>
  <script type="text/javascript" src="../../src/patterns/GossipFactory.js"></script>
  <script type="text/javascript" src="../../src/apis/GossipProtocol.js"></script>
  <script type="text/javascript" src="../../src/algorithms/Vicinity.js"></script> 
  <script type="text/javascript" src="../../src/algorithms/Cyclon.js"></script>
  <script type="text/javascript" src="../../src/algorithms/RandomPeerSampling.js"></script>
  <script type="text/javascript" src="./Plotter.js"></script>
  <script type="text/javascript" src="./Coordinator.js"></script>
  <script type="text/javascript" src="./confObj.js"></script>
  <script>
    //main
    $(document).ready(function(){
      var gRef = {};
      //first function to be executed
      //$('#start').click( function(){
        var userName = '#userId';
        if( userName === '' )
          alert("Type your name please");
        else{
          $('#start').attr('disabled', 'disabled');
          var index = #userProfile; 
          configurationObj['peerId'] = userName;
          configurationObj.gossipAlgos.cyclon1['data'] = index;
          configurationObj.gossipAlgos.vicinity1['data'] = index;
          //document.getElementById('profile').style.color = 'black';
          //document.getElementById('profile').innerHTML = 'Getting data for plotting...';
          //gRef.pool = window.setInterval(function(){
          //  isFirstGraphDrawn(gRef.coord.first);
          //  }, 2000);
          gRef.coord = new Coordinator(configurationObj);
        }
      //});
      //shows text when graphs load
      function isFirstGraphDrawn(first){
        console.debug('isFirstGraphDrawn: ?');
        if(first === 1){
          console.debug('isFirstGraphDrawn: YES');
          document.getElementById('profile').style.color = 'black';
          document.getElementById('profile').innerHTML = 'Graphs were created!';
          clearInterval(gRef.pool);
        }else{
          console.debug('isFirstGraphDrawn: NO');
          if(document.getElementById('profile').style.color === 'black'){
            document.getElementById('profile').style.color = 'white'; 
          }else{
            document.getElementById('profile').style.color = 'black';
          }
        }
      }


      $('#connect').click(function() {
        var peer = gRef.coord;
        var requestedPeer = $('#rid').val();
        if(!peer.connectedPeers[requestedPeer]){
          var c = peer.connect(requestedPeer, {
            label: 'chat',
            serialization: 'none',
            metadata: {message: 'hi i want to chat with you!'}
          });
          c.on('open', function() {
            peer.handleChatMsg(c);
          });
          c.on('error', function(err) { alert(err); });
        }
        peer.connectedPeers[requestedPeer] = 1;
      });
      // Close a connection.
      $('#close').click(function() {
        eachActiveConnection(function(c) {
          c.close();
        });
      });
      // Send a chat message to all active connections.
      $('#send').submit(function(e) {
        e.preventDefault();
        // For each active connection, send the message.
        var msg = $('#text').val();
        eachActiveConnection(function(c, $c) {
          if (c.label === 'chat') {
            c.send(msg);
            $c.find('.messages').append('<div><span class="you">You: </span>' + msg + '</div>');
          }
        });
        $('#text').val('');
        $('#text').focus();
      });
      // Goes through each active peer and calls FN on its connections.
      function eachActiveConnection(fn) {
        var peer = gRef.coord;
        var actives = $('.active');
        var checkedIds = {};
        actives.each(function() {
          var peerId = $(this).attr('id');
          if (!checkedIds[peerId]) {
            var conns = peer.connections[peerId];
            for (var i = 0, ii = conns.length; i < ii; i += 1) {
              var conn = conns[i];
              fn(conn, $(this));
            }
          }
          checkedIds[peerId] = 1;
        });
      }
      function isFirstGraphDrawn(first){
        console.debug('isFirstGraphDrawn: ?');
        if(first === 1){
          console.debug('isFirstGraphDrawn: YES');
          document.getElementById('profile').style.color = 'black';
          document.getElementById('profile').innerHTML = 'Graphs were created!';
          clearInterval(gRef.pool);
        }else{
          console.debug('isFirstGraphDrawn: NO');
          if(document.getElementById('profile').style.color === 'black'){
            document.getElementById('profile').style.color = 'white'; 
          }else{
            document.getElementById('profile').style.color = 'black';
          }
        }
      }
    });
  </script>
</head>
<!-- <title>WebGC demo</title> -->
<body style="zoom: 1; background-color: #ddd;">
  <div id="main" class="mainContainer">
    <div id="form" class="formContainer">
      <h2>Preferences</h2>
        Your peer ID: <input type="text" id="user" placeholder="Write your ID, here!">
        Your preference is :
        <select id="list">
          <option value="v1">Internet of Things</option>
          <option value="v2">P2P Systems</option>
          <option value="v3">Cloud Computing</option>
          <option value="v4">Big Data</option>
        </select>
        <input class="button" type="button" value="START" id="start">
        <div id="statusSec" class="status_section">
          <div id="profile" class="profiile_cls"></div>
          <div id="info" class="info_cls">
            <img src="legend.png" alt="" style="width:800px;height:100px;align:middle">
          </div>
        </div> 
    </div>
    <div id="graphs" class="graphsContainer">
      <div id="rps-section" class="rpsContainer"></div>
      <div id="clu-section" class="cluContainer"></div>
    </div>
    <div id="chat" class="chatContainer">
      <div id="actions">
        Your peer ID is: <span id="pid"></span><br>
        Connect to a peer: <input type="text" id="rid" 
          placeholder="Someone else's id">
        <input class="button" type="button" value="Connect"
          id="connect">
        <br><br>
        <form id="send">
          <input type="text" id="text" placeholder="Enter message">
          <input class="button" type="submit" value="Send to selected peers">
        </form>
        <button id="close">Close selected connections</button>
      </div>
      <div id="wrap"><div id="connections"><span class="filler">You have not yet
        made any connections.</span></div>
        <div class="clear"></div>
      </div>
      <!--
      <div id="box" style="background: #fff; font-size: 18px;padding:40px 30px; text-align: center;">
        Drag file here to send to active connections.
      </div>
      -->
    </div>
  </div>
</body>  
</html>
