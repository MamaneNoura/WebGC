<html lang="en">
<head>
  <title>WebGC demo</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
  <meta http-equiv="Content-Language" content="en-us">
  <link href="webgc_demo.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="../../bower_components/jquery/dist/jquery.min.js"></script> 
  <script type="text/javascript" src="../../bower_components/peerjs/peer.js"></script>
  <script type="text/javascript" src="../../bower_components/cytoscape/dist/cytoscape.js"></script>
  <script type="text/javascript" src="../../src/utils/LoggerForWebWorker.js"></script>
  <script type="text/javascript" src="../../src/utils/GossipUtil.js"></script>
  <script type="text/javascript" src="../../src/services/LookupService.js"></script>
  <script type="text/javascript" src="../../src/services/GossipFactory.js"></script>
  <script type="text/javascript" src="../../src/superObjs/GossipProtocol.js"></script>
  <script type="text/javascript" src="../../src/algorithms/Vicinity.js"></script>
  <script type="text/javascript" src="../../src/algorithms/Cyclon.js"></script>
  <script type="text/javascript" src="../../src/services/Bootstrap.js"></script>
  <script type="text/javascript" src="../../src/services/Plotter.js"></script>
  <script type="text/javascript" src="../../src/controllers/Coordinator.js"></script>
  <script type="text/javascript" src="../../src/confObjs/twoSimFunc.js"></script>
  
  <script>
    var mainObjs = {};
    var chatElement = 0;
    function addChatElement(){
      var peerId = "peer_" + chatElement;
      chatElement++;
      var chatbox = $('<div></div>').addClass('connection').addClass('active').attr('id', peerId);
      var header = $('<h1></h1>').html('Chat with <strong>' + peerId + '</strong>');
      var messages = $('<div><em>Peer connected.</em></div>').addClass('messages');
      chatbox.append(header);
      chatbox.append(messages);
       
      // Select connection handler.
      chatbox.on('click', function() {
        if ($(this).attr('class').indexOf('active') === -1) {
          $(this).addClass('active');
        } else {
          $(this).removeClass('active');
        }
      });
      
      $('.filler').hide();
      $('#connections').append(chatbox);
    }
    function getGraph(host, port, plotterLoop, workers){
      var http = new XMLHttpRequest();
      var url = 'http://' + host + ':' + port + '/getGraph';
      var self = this;
      http.open('get', url, true);
      http.onerror = function(e) {
        self.log.error('Trying to get graph for loop ' + plotterLoop);
      };
      http.onreadystatechange = function() {
        if (http.readyState !== 4) { return; }
        if (http.status !== 200) {
          http.onerror();
          return;
        }
        console.log('Graph ' + http.responseText + ' for loop ' + plotterLoop);
        var nodes = JSON.parse(http.responseText);
        var msg = {header: 'view', graph: nodes};
        var keys = Object.keys(workers), worker;
        for(var i = 0; i < keys.length; i++){
          worker = workers[ keys[i] ];
          worker.postMessage(msg);
        }
      };
      http.send(null);
    }
    //main
    $(document).ready(function(){
      $('start').click(function(){
        console.log('Start...');
        var peerId = document.getElementById('user').value;
        if(peerId && peerId != ''){
          console.log('peerId is not null');
          document.getElementById('start').disabled = true;
          var profile = [];
          for(var i = 1; i<=3; i++)
            profile.push(document.getElementById("list" + i).value);
        var controller = new Coordinator(configurationObj, profile, peerId);
        controller.listen();
        var plotter = new Plotter(peerId, {});
        controller.plotterObj = plotter;
        var self = this;
        window.setInterval( function(){
          var host = configurationObj.peerJsOpts.host;
          var port = configurationObj.peerJsOpts.port;
          getGraph(host, port, plotter.loop, controller.workers);
          plotter.loop++;
        }, 15000);
        }else
          alert("Your PeerID could not be empty");
      });
    });
  </script>
</head>
<!-- <title>WebGC demo</title> -->
<body style="zoom: 1; background-color: #ddd;">
  <div id="main" class="mainContainer">
    <div id="form" class="formContainer">
      <h2>Preferences</h2>
        Your PeerId: <input type="text" id="user" placeholder="Write your ID, here!">
        <input class="button" type="button" value="START" id="start">
        <input class="button" type="button" value="AddChatBox" onclick="addChatElement()">
        <br><br>
        Your profile is:
        <select id="list1">
          <option value="v1">Internet of Things</option>
          <option value="v2">P2P Systems</option>
          <option value="v3">Cloud Computing</option>
          <option value="v4">Recommendation protocols</option>
        </select>
        <select id="list2">
          <option value="v1">Internet of Things</option>
          <option value="v2">P2P Systems</option>
          <option value="v3">Cloud Computing</option>
          <option value="v4">Recommendation protocols</option>
        </select>
        <select id="list3">
          <option value="v1">Internet of Things</option>
          <option value="v2">P2P Systems</option>
          <option value="v3">Cloud Computing</option>
          <option value="v4">Recommendation protocols</option>
        </select>
        <!--
        <div id="statusSec" class="status_section">
          <div id="profile" class="profiile_cls"></div>
          <div id="info" class="info_cls">
            <img src="legend.png" alt="" style="width:800px;height:100px;align:middle">
          </div>
        </div> 
        -->
    </div>
    <div id="graphs" class="graphsContainer">
      <div id="rps-section" class="rpsContainer"></div>
      <div id="clu-section" class="cluContainer"></div>
    </div>
    <div id="chat" class="chatContainer">
      <div id="actions">
        Your peer ID is: <span id="pid"></span><br>
        <!--
        Connect to a peer: <input type="text" id="rid" 
          placeholder="Someone else's id">
        <input class="button" type="button" value="Connect"
          id="connect">
        <br><br>
        -->
        <form id="send">
          <input type="text" id="text" placeholder="Enter message">
          <input class="button" type="submit" value="Send to selected peers">
        </form>
        <!-- <button id="close">Close selected connections</button> -->
      </div>
      <div id="wrap"><div id="connections"><span class="filler">You have not yet
        made any connections.</span></div>
        <div class="clear"></div>
      </div>
    </div>
  </div>
</body>  
</html>
